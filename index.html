<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mario JS</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100%;
    }

    canvas {
      background: #87CEEB;
      display: block;
      width: 100vw;
      height: 100vh;
    }

    #modalNivel {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 24px;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 10;
    }

    #modalNivel > div {
      background: #222;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

    #modalNivel button {
      margin-top: 10px;
      padding: 10px 20px;
      font-size: 18px;
      cursor: pointer;
    }

    #controles {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: flex;
      gap: 20px;
    }

    #controles button {
      font-size: 28px;
      padding: 16px 24px;
      border: none;
      border-radius: 12px;
      background-color: #333;
      color: white;
      box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    }
  </style>
</head>
<body>
  <canvas id="juego"></canvas>

  <div id="controles">
    <button id="btnLeft">◀️</button>
    <button id="btnJump">⤒</button>
    <button id="btnRight">▶️</button>
  </div>

  <div id="modalNivel">
    <div>
      <p>¡Nivel completado!</p>
      <button onclick="siguienteNivel()">Siguiente Nivel</button>
    </div>
  </div>

<script>
const canvas = document.getElementById("juego");
const ctx = canvas.getContext("2d");
let juegoPausado = false;
let niveles = [], nivelActual = 0;
let platforms = [], coin = {}, enemy = {};

const marioImg = new Image(); marioImg.src = "img/mario.gif";
const coinImg = new Image();  coinImg.src = "img/coin.png";
const enemyImg = new Image(); enemyImg.src = "img/enemy.png";

const player = {
  x: 50, y: 0, width: 40, height: 40,
  vx: 0, vy: 0,
  onGround: false,
  score: 0
};

const keys = {};
document.addEventListener("keydown", e => keys[e.code] = true);
document.addEventListener("keyup", e => keys[e.code] = false);

document.getElementById("btnLeft").addEventListener("touchstart", () => keys["ArrowLeft"] = true);
document.getElementById("btnLeft").addEventListener("touchend", () => keys["ArrowLeft"] = false);
document.getElementById("btnRight").addEventListener("touchstart", () => keys["ArrowRight"] = true);
document.getElementById("btnRight").addEventListener("touchend", () => keys["ArrowRight"] = false);
document.getElementById("btnJump").addEventListener("touchstart", () => {
  if (player.onGround) keys["Space"] = true;
});
document.getElementById("btnJump").addEventListener("touchend", () => keys["Space"] = false);

function ajustarCanvas() {
  const alturaReal = document.documentElement.clientHeight;
  canvas.width = window.innerWidth;
  canvas.height = alturaReal;
}

function generarNiveles() {
  niveles = [];
  for (let i = 0; i < 7; i++) {
    const plataformas = [];
    plataformas.push({ x: 0, y: canvas.height - 50, width: canvas.width, height: 50 });

    const escalones = Math.floor(Math.random() * 4) + 3; // entre 3 y 6 plataformas
    let stepX = 80;
    let stepY = 60;
    let px = 80;
    let py = canvas.height - 120;

    for (let j = 0; j < escalones; j++) {
      const width = 100;
      plataformas.push({ x: px, y: py, width: width, height: 20 });
      px += width + Math.floor(Math.random() * 60 + 40);
      py -= stepY + Math.floor(Math.random() * 20);
    }

    const last = plataformas[plataformas.length - 1];
    const coin = {
      x: last.x + last.width / 2 - 10,
      y: last.y - 20,
      width: 20,
      height: 20,
      collected: false
    };

    const enemy = {
      x: Math.floor(Math.random() * (canvas.width - 50)),
      y: canvas.height - 90,
      width: 40,
      height: 40,
      dir: Math.random() < 0.5 ? -1 : 1
    };

    niveles.push({ plataformas, coin, enemy });
  }
}

function cargarNivel(n) {
  const nivel = niveles[n];
  platforms = nivel.plataformas;
  coin = { ...nivel.coin };
  enemy = { ...nivel.enemy };
  player.x = 50;
  player.y = canvas.height / 2;
  player.vx = 0;
  player.vy = 0;
}

function update() {
  if (keys["ArrowLeft"]) player.vx = -5;
  if (keys["ArrowRight"]) player.vx = 5;
  if (keys["Space"] && player.onGround) {
    player.vy = -15;
    player.onGround = false;
  }

  player.vy += 0.8;
  player.x += player.vx;
  player.y += player.vy;
  player.vx *= 0.9;

  player.onGround = false;
  platforms.forEach(p => {
    if (
      player.x < p.x + p.width &&
      player.x + player.width > p.x &&
      player.y < p.y + p.height &&
      player.y + player.height > p.y
    ) {
      if (player.vy > 0) {
        player.y = p.y - player.height;
        player.vy = 0;
        player.onGround = true;
      }
    }
  });

  if (!coin.collected &&
      player.x < coin.x + coin.width &&
      player.x + player.width > coin.x &&
      player.y < coin.y + coin.height &&
      player.y + player.height > coin.y) {
    coin.collected = true;
    player.score += 1;
    juegoPausado = true;
    setTimeout(() => {
      document.getElementById("modalNivel").style.display = "flex";
    }, 300);
  }

  enemy.x += enemy.dir * 2;
  if (enemy.x <= 0 || enemy.x + enemy.width >= canvas.width) enemy.dir *= -1;

  if (
    player.x < enemy.x + enemy.width &&
    player.x + player.width > enemy.x &&
    player.y < enemy.y + enemy.height &&
    player.y + player.height > enemy.y
  ) {
    alert("¡Perdiste! Tu puntaje fue: " + player.score);
    location.reload();
  }
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.fillStyle = "#228B22";
  platforms.forEach(p => ctx.fillRect(p.x, p.y, p.width, p.height));

  ctx.drawImage(marioImg, player.x, player.y, player.width, player.height);
  if (!coin.collected) ctx.drawImage(coinImg, coin.x, coin.y, coin.width, coin.height);
  ctx.drawImage(enemyImg, enemy.x, enemy.y, enemy.width, enemy.height);

  ctx.fillStyle = "black";
  ctx.font = "20px Arial";
  ctx.fillText("Puntaje: " + player.score, 10, 25);
}

function loop() {
  if (!juegoPausado) {
    update();
    draw();
    requestAnimationFrame(loop);
  }
}

function siguienteNivel() {
  nivelActual++;
  if (nivelActual >= niveles.length) {
    alert("¡Juego terminado! Puntaje total: " + player.score);
    location.reload();
  } else {
    cargarNivel(nivelActual);
    document.getElementById("modalNivel").style.display = "none";
    juegoPausado = false;
    loop();
  }
}

function iniciarJuego() {
  ajustarCanvas();
  setTimeout(() => {
    ajustarCanvas();
    generarNiveles();
    cargarNivel(nivelActual);
    loop();
  }, 100);
}

window.addEventListener("load", iniciarJuego);
window.addEventListener("resize", ajustarCanvas);
</script>
</body>
</html>
